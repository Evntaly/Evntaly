<div class="nk-block-head nk-block-head-sm">
  <div class="nk-block-between g-3">
    <div class="nk-block-head-content">
      <h3 class="nk-block-title page-title">User Details</h3>
      <div class="nk-block-des text-soft">
        <div class="nk-block-des text-soft">
          <ul class="list-inline">
            <li>User ID: <span class="text-base"> {{ user_details?.user?.id }}
              </span>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="nk-block-head-content">
      <a (click)="back()" class="btn btn-outline-light bg-white d-none d-sm-inline-flex"><em
          class="icon ni ni-arrow-left"></em><span>Back</span></a>
      <a (click)="back()" class="btn btn-icon btn-outline-light bg-white d-inline-flex d-sm-none"><em
          class="icon ni ni-arrow-left"></em></a>
    </div>
  </div>
</div>


<div class="nk-block">
  <div class="row g-gs">
    <div class="col-xl-4">
      <div class="nk-block mb-3">
        <div class="card clickable-card">
          <div class="card-inner">
            <div class="d-flex position-relative" *ngIf="user_details?.user?.full_name">
              <div class="user-avatar" >
                {{ user_details?.user?.initials }}
              </div>
              <div class="ms-4 flex-grow-1" *ngIf="user_details?.user?.full_name">
                <h4 class="title mb-1">{{ user_details?.user?.full_name }} </h4>
                <p class="sub-text mb-1">{{ user_details?.user?.email }}</p>
                <ul class="nk-history-meta">
                  <li><a href="" class="custom-link">{{ user_details?.user?.organization }}</a></li>
                  <li>{{ user_details?.user?.createdAt | date:'short' }}</li>
                </ul>
              </div>
            </div>
            <div class="d-flex position-relative" *ngIf="!user_details?.user?.full_name">
              <div class="ms-4 flex-grow-1">
                <h4 class="title mb-1">Name Not Provided
                  <em class="icon ni ni-info" matTooltip="The user has not provided their name, This user only identified by their ids."></em>
                </h4>
                <p class="sub-text mb-1">{{ user_details?.user?.email }}</p>
                <ul class="nk-history-meta">
                  <li><a href="" class="custom-link">{{ user_details?.user?.organization || 'N/A' }}</a></li>
                  <li>{{ user_details?.user?.createdAt | date:'short' }}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-inner-group">
          <div class="card-inner">
            <div class="row gy-3 justify-content-center text-center">
              <div class="col">
                <div class="profile-stats">
                  <span class="amount">{{ user_details?.kpis?.events_count }}</span>
                  <span class="sub-text">Events</span>
                </div>
              </div>
              <div class="col">
                <div class="profile-stats">
                  <span class="amount">{{ user_details?.kpis?.sessions_unique_count }}</span>
                  <span class="sub-text">Sessions</span>
                </div>
              </div>
              <div class="col">
                <div class="profile-stats">
                  <span class="amount" *ngIf="user_details?.first_last_events?.lastEvent">
                    {{ timeAgo(user_details?.first_last_events?.lastEvent?.timestamp) }}
                  </span>
                  <span class="amount" *ngIf="!user_details?.first_last_events?.lastEvent">
                    N/A
                  </span>
                  <span class="sub-text">LSA</span>
                </div>
              </div>
            </div>
          </div>
          <div class="card-inner">
            <h6 class="overline-title mb-2"><em class="icon ni ni-spark-fill"></em> Insights </h6>
            <div class="row g-3">
              <div class="col-sm-6 col-md-4 col-xl-12">
                <span class="sub-text mb-1">First Seen <em
                    matTooltip="Represents the date when the user submitted their most recent event regardless the event name."
                    matTooltipPosition="above" class="icon ni ni-info"></em></span>
                <span *ngIf="user_details?.first_last_events?.firstEvent">{{ user_details?.first_last_events?.firstEvent?.timestamp | date: 'fullDate' }}</span>
                <span *ngIf="!user_details?.first_last_events?.firstEvent">No events have been sent yet.</span>
              </div>
              <div class="col-sm-6 col-md-4 col-xl-12">
                <span class="sub-text mb-1">Last Seen <em
                    matTooltip="Represents the date when the user submitted their most recent event regardless the event name."
                    matTooltipPosition="above" class="icon ni ni-info"></em></span>
                <span *ngIf="user_details?.first_last_events?.lastEvent"> {{ user_details?.first_last_events?.lastEvent?.timestamp | date: 'fullDate' }}</span>
                <span *ngIf="!user_details?.first_last_events?.lastEvent">No events have been sent yet.</span>
              </div>
              <div class="col-sm-6 col-md-4 col-xl-12">
                <span class="sub-text mb-1">Registered <em
                    matTooltip="Represents the date when the user submitted their most recent event regardless the event name."
                    matTooltipPosition="above" class="icon ni ni-info"></em></span>
                <span>{{ user_details?.user?.createdAt | date:'fullDate' }}</span>
              </div>
              <div class="col-sm-6 col-md-4 col-xl-12 mb-4">
                <span class="sub-text mb-2">Top Used Feature</span>
                <div class="custom-control custom-checkbox custom-control-pro no-control">
                  <label *ngIf="user_details?.most_used_feature?.feature" class="custom-control-label" for="btnIconRadio1">
                    <em class="icon ni ni-hash"></em> <span>{{ user_details?.most_used_feature?.feature  }} ({{ user_details?.most_used_feature?.count }})</span>
                  </label>
                  <span *ngIf="!user_details?.most_used_feature?.feature">No events have been sent yet.</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-8">
      <div class="card">
        <div class="card-inner">

          <div class="nk-block" *ngIf="!loading">
            <h6 class="lead-text mb-3">User Activity</h6>
            <evntaly-heatmap [action]="heatmap_action" [mode]="heatmap_mode" [theme]="heatmap_theme"
              [options]="heatmap_options" [data]="user_heatmap_data">
            </evntaly-heatmap>
          </div>

          <div class="nk-block" style="margin-bottom: 20px;">
            <h6 class="lead-text mb-2">User Vitals</h6>

            <div class="row g-gs">
              <div class="col-sm-12 col-md-6 col-xxl-6">
                <div class="card bg-primary">
                  <div class="card-inner" style="padding: 15px;">
                    <div class="d-flex align-items-center justify-content-between mb-1">
                      <div class="text-white mb-0"><em class="icon ni ni-bar-fill-c"></em> Engagament Depth
                        <em class="icon ni ni-info" matTooltip="The Engagement Depth measures how engaged the user is during a session, typically calculated as the average number of events per session."></em>
                      </div>
                    </div>
                    <h5 class="fs-4 text-white">{{ user_vitals.engagement_depth }} E/s</h5>
                  </div>
                </div>
              </div>
              <div class="col-sm-12 col-md-6 col-xxl-6">
                <div class="card bg-primary">
                  <div class="card-inner" style="padding: 15px;">
                    <div class="d-flex align-items-center justify-content-between mb-1">
                      <div class="text-white mb-0"><em class="icon ni ni-coffee-fill"></em> Bounce Rate
                        <em class="icon ni ni-info" matTooltip="The Bounce Rate is the percentage of sessions in which the user only sent a single event (no further interaction occurred)."></em>
                      </div>
                    </div>
                    <h5 class="fs-4 text-white">{{ user_vitals.bounce_rate }}%</h5>
                  </div>
                </div>
              </div>

              <div class="col-sm-12 col-md-6 col-xxl-6">
                <div class="card bg-primary">
                  <div class="card-inner" style="padding: 15px;">
                    <div class="d-flex align-items-center justify-content-between mb-1">
                      <div class="text-white mb-0"><em class="icon ni ni-clock-fill"></em> Average Session Duration
                        <em class="icon ni ni-info" matTooltip="The Average Session Duration is the average time a user spends in a session. You have full control over how sessions are defined."></em>
                      </div>
                    </div>
                    <h5 class="fs-4 text-white">{{ user_vitals.avg_session_duration }}</h5>
                  </div>
                </div>
              </div>
              <div class="col-sm-12 col-md-6 col-xxl-6">
                <div class="card" [ngClass]="{ 'bg-warning': user_vitals.general_status == 'Lazy' , 'bg-danger': user_vitals.general_status == 'Idle' , 'bg-success': user_vitals.general_status == 'Active' }">
                  <div class="card-inner" style="padding: 15px;">
                    <div class="d-flex align-items-center justify-content-between mb-1">
                      <div class="text-white mb-0"><em class="icon ni ni-bell-fill"></em>
                        General Status
                        <em class="icon ni ni-info" matTooltip="Labeling the user based on the number of sessions and their activity, making it easier to distinguish their overall status."></em>
                      </div>
                    </div>
                    <h5 class="fs-4 text-white">{{ user_vitals.general_status }}</h5>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="nk-block" style="margin-bottom: 20px;">
            <h6 class="lead-text mb-3">Activation Pipeline
                ({{ checklist_count }}/{{ events_checklist.length }})</h6>

            <div class="row g-3" *ngIf="events_checklist.length > 0">
              <ng-container *ngFor="let e of events_checklist">
                <div class="col-12 col-lg-6 col-xl-12">
                  <div class="card">
                    <div class="card-inner" style="padding: 13px;">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                          <div class="icon-circle icon-circle-lg" [ngClass]="{ 'bg-success' : e.is_existing , 'bg-danger' : !e.is_existing }">
                            <em *ngIf="e.is_existing" class="icon ni ni-check-thick"></em>
                            <em *ngIf="!e.is_existing"  class="icon ni ni-cross"></em>
                          </div>
                          <div class="ms-3">
                            <h6 class="fs-6 lead-text">{{ e.title }}</h6>
                            <span *ngIf="e.is_existing" class="sub-text">Event first occurred on <strong> {{ e.first_occurance_date | date: 'short' }} </strong></span>
                            <span *ngIf="!e.is_existing" class="sub-text">Event was not sent by the user yet.</span>
                          </div>
                        </div>
                        <ul class="btn-toolbar justify-center gx-1 me-n1 flex-nowrap" *ngIf="e.is_existing" matTooltip="Show occurance">
                          <li><a (click)="showEventOccurance(e.eventID)" class="btn btn-trigger btn-icon"><em class="icon ni ni-arrow-up-right"></em></a></li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>
            <evntaly-empty-state icon="icon ni ni-archived" *ngIf="!events_checklist.length"
              msg="No events have been added to the activation pipeline." link-msg="Add them here." link="/occurances/all"></evntaly-empty-state>
          </div>

          <div class="nk-block" style="margin-bottom: 20px;">
            <h6 class="lead-text mb-3">Additional Attributes</h6>
            <div class="card unshadowed-card" *ngIf="user_details?.user?.data">
              <button (click)="copyToClipboard()"
                data-bs-placement="bottom" title="Copy JSON" class="btn btn-xs btn-dark cpy">
                <em class="icon ni ni-copy-fill"></em>
              </button>
              <pre class="prettyprint lang-html jsonv-container"
                [innerHTML]="syntaxHighlight()"></pre>
            </div>

            <evntaly-empty-state icon="icon ni ni-archived" *ngIf="!user_details?.user?.data"
            msg="Emm! It looks like this user didn't bring any extra data along."></evntaly-empty-state>
          </div>

          <div class="nk-block">
            <h6 class="lead-text">Alert</h6>
            <div class="card" *ngIf="event_alert">
              <div class="card-inner">
                <div class="between-center flex-wrap flex-md-nowrap g-3">
                  <div class="media media-center gx-3 wide-xs">

                    <div class="media-content">
                      <h6>Alert Details</h6>
                      <p>Alert will be triggered if the event sent more than, <strong> {{ event_alert.occurances }}</strong> Times in <strong>One {{
                          event_alert.period }}</strong>.</p>
                    </div>
                  </div>
                  <div class="nk-block-actions flex-shrink-0">
                    <div class="dropdown">
                      <a class="dropdown-toggle btn btn-icon btn-light" data-bs-toggle="dropdown"><em
                          class="icon ni ni-more-h"></em></a>
                      <div class="dropdown-menu dropdown-menu-end">
                        <ul class="link-list-opt no-bdr">
                          <!-- <li aria-disabled="true">
                            <a href="#">
                              <em class="icon ni ni-caution-fill"></em>
                              <span>Disable</span>
                            </a>
                          </li> -->
                          <li><a style="color: rgb(193, 0, 0); cursor: pointer;"><em
                                class="icon ni ni-trash" style="color: rgb(193, 0, 0);"></em><span>Delete</span></a>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="card" *ngIf="!event_alert">
              <div class="card-inner">
                <div class="between-center flex-wrap flex-md-nowrap g-3">
                  <div class="media media-center gx-3 wide-xs">
                    <div class="media-content">
                      <p>This user currently has no alerts configured. To monitor this user behavior, please create an alert.
                      </p>
                    </div>
                  </div>
                  <div class="nk-block-actions flex-shrink-0" (click)="createAlert()">
                    <a class="btn btn-lg btn-light">Create Alert</a>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>
